[?1049h[?1h=[1;62r[?12;25h[?12l[?25h[27m[23m[m[H[2J[?25l[62;1H"sys.c" 223L, 5460C[2;1H[35m#include [m[31m<mm.h>[m

[35m#include [m[31m<mm_address.h>[m

[35m#include [m[31m<sched.h>[m

[35m#include [m[31m<errno.h>[m

[35m#include [m[31m<entry.h>[m

[35m#define LECTURA [m[31m0[m
[35m#define ESCRIPTURA [m[31m1[m

[32mextern[m [32mstruct[m list_head freequeue;
[32mextern[m [32munsigned[m [32mlong[m last_PID;

[32mint[m check_fd([32mint[m fd, [32mint[m permissions)
{
  [38;5;130mif[m (fd!=[31m1[m) [38;5;130mreturn[m -[31m9[m; [34m/*EBADF*/[m
  [38;5;130mif[m (permissions!=ESCRIPTURA) [38;5;130mreturn[m -[31m13[m; [34m/*EACCES*/[m
  [38;5;130mreturn[m [31m0[m;
}

[32mint[m sys_ni_syscall()
{[27;9H[38;5;130mreturn[m -[31m38[m; [34m/*ENOSYS*/[m
}

[32mint[m sys_getpid()
{[32;9H[38;5;130mreturn[m current()->PID;
}

[32mint[m sys_fork()
{[38;9H[32mint[m PID=-[31m1[m;[40;9H[32munion[m task_union* child_union;[41;9H[32munion[m task_union* parent_union;[43;9H[38;5;130mif[m (list_empty(&freequeue)) {[44;17Hprintk([31m"Insert an error code, that means there are no more pcb's"[m);[46;17H[38;5;130mreturn[m -[31mECHILD[m;[47;9H}[48;9H[38;5;130melse[m {[49;17H[32mstruct[m list_head* lh = list_first (&freequeue);[50;17Hlist_del(lh);[52;17H[32mstruct[m task_struct* child = list_head_to_task_struct(lh);[53;17Hchild_union = ([32munion[m task_union*)child;[55;17H[32mstruct[m task_struct* parent = current();[56;17Hparent_union = ([32munion[m task_union*)parent;[58;17H[34m//The size of the union is the max(task_struct, stack)  [m[59;17Hcopy_data(parent_union, child_union, [38;5;130msizeof[m([32munion[m task_union));[61;17Hallocate_DIR(&(child_union->task));[62;112H69,3-17[8C4%[61;17H[?12l[?25h[?25l
Type  :quit<Enter>  to exit Vim[62;112H[K[62;112H69,3-17[8C4%[61;17H[?12l[?25h[?25l[62;112H[K[62;112H69,3-17[8C4%[61;17H[?12l[?25h[?25l[62;112H[K[62;112H69,3-17[8C4%[61;17H[?12l[?25h[?25l[1;61r[61;1H
[1;62r[47;14H[106m{[61;9H}[m[62;1H[K[62;112H70,2-9[9C5%[61;9H[?12l[?25h[?25l[1;61r[1;1H[30M[1;62r[17;14H{[31;9H}[33;9H[34m//Search for physical pages[m[34;9H[32mint[m i = [31m0[m; [32mint[m frame;[35;9H[32munsigned[m [32mint[m ph_pages [NUM_PAG_DATA];[37;9H[38;5;130mwhile[m (frame >= [31m0[m && i < NUM_PAG_DATA) {[38;17Hframe = alloc_frame();[39;17Hph_pages [i] = frame;[40;17Hi++;[41;9H}[43;9H[38;5;130mif[m (frame < [31m0[m) {[44;17Hprintk([31m"Insert an error code, no more physical pages available"[m);[46;17Hfree_user_pages(&(child_union->task));[48;17H[32mint[m size_phpages = i;[49;17H[38;5;130mfor[m (i = [31m0[m; i < size_phpages; ++i) free_frame(ph_pages [i]);[51;17Hlist_add_tail (&(child_union->task.list), &freequeue); [34m//Free frames and restore pcb            [m[53;17H[38;5;130mreturn[m -[31mENOMEM[m;[54;9H}[56;9Hi = [31m0[m;[57;9Hpage_table_entry* PT_child = get_PT(&(child_union->task));[58;9Hpage_table_entry* PT_parent = get_PT(&(parent_union->task));[60;9H[38;5;130mwhile[m (i < NUM_PAG_KERNEL) {[61;17H[32munsigned[m [32mint[m kernel_frame_number = get_frame(PT_parent, i);[62;112H[K[62;112H100,3-17      24%[61;17H[?12l[?25h[?25l
Type  :quit<Enter>  to exit Vim[62;112H[K[62;112H100,3-17      24%[61;17H[?12l[?25h[?25l
[1m-- VISUAL BLOCK --[m[62;21H[K[62;112H100,3-17      24%[61;17H[?12l[?25h[?25l[62;1H[K[62;112H100,3-17      24%[61;17H[?12l[?25h[?25l[1;61r[61;1H
[1;62r[61;17Hset_ss_pag(PT_child, i, kernel_frame_number);[62;112H[K[62;112H101,3-17      24%[61;17H[?12l[?25h[?25l[1;61r[61;1H
[1;62r[61;17H[34m//from 0 to 255 because we know that addresses (kernel ph_pages)[m[62;112H[K[62;112H102,3-17      25%[61;17H[?12l[?25h[?25l
[1m-- VISUAL --[m[62;112H[K[62;112H102,3-17      25%[61;17H[?12l[?25h[?25l[34m[47m/[m[62;116H4-18[61;18H[?12l[?25h[?25l[1;61r[1;1H[2M[1;62r[56;36H[106m{[m[59;18H[34m[47m/from 0 to 255 because we know that addresses (kernel ph_pages)[m[47m 
                i++; 
        [m[106m}[m[62;112H[K[62;112H104,2-9[7C26%[61;9H[?12l[?25h[?25l[56;36H{[59;17H[K[60;1H[K[61;1H        i = NUM_PAG_KERNEL;[62;1H[K[62;112H102,2-16      26%[59;16H[?12l[?25h[?25l


[1m-- INSERT --[m[62;112H[K[62;112H102,2-9[7C26%[59;9H[?12l[?25h[?25ld[62;116H3-10[59;10H[?12l[?25h[?25lf[62;116H4-11[59;11H[?12l[?25h[?25ll[62;116H5-12[59;12H[?12l[?25h[?25la[62;116H6-13[59;13H[?12l[?25h[?25ls[62;116H7-14[59;14H[?12l[?25h[?25ld[62;116H8-15[59;15H[?12l[?25h[?25lf[62;116H9-16[59;16H[?12l[?25h[?25la[62;116H10-17[59;17H[?12l[?25h[?25lk[62;117H1-18[59;18H[?12l[?25h[?25ls[62;117H2-19[59;19H[?12l[?25h[?25ll[62;117H3-20[59;20H[?12l[?25h[?25lf[62;117H4-21[59;21H[?12l[?25h[?25lj[62;117H5-22[59;22H[?12l[?25h[?25la[62;117H6-23[59;23H[?12l[?25h[?25ls[62;117H7-24[59;24H[?12l[?25h[?25lf[62;117H8-25[59;25H[?12l[?25h[?25l[59;9H[38;5;130mdflasdfakslfjasf[m:[62;117H9-26[59;26H[?12l[?25h[?25lw[62;116H20-27[59;27H[?12l[?25h[?25la[62;117H1-28[59;28H[?12l[?25h[?25lh[62;117H2-29[59;29H[?12l[?25h[?25li[62;117H3-30[59;30H[?12l[?25h[?25lq[62;117H4-31[59;31H[?12l[?25h[?25lw[62;117H5-32[59;32H[?12l[?25h[?25le[62;117H6-33[59;33H[?12l[?25h[?25ll[62;117H7-34[59;34H[?12l[?25h[?25lr[62;117H8-35[59;35H[?12l[?25h[?25l[62;1H[K[62;112H102,27-34     26%[59;34H[?12l[?25h[?25l[62;114H3,0-1  [60;1H[?12l[?25h[?25l[62;114H4,2-9[61;9H[?12l[?25h[?25l
Type  :quit<Enter>  to exit Vim[62;112H[K[62;112H104,2-9[7C26%[61;9H[?12l[?25h[?25l[1;61r[61;1H
[1;62r[61;9H[38;5;130mwhile[m (i < NUM_PAG_KERNEL + NUM_PAG_CODE) {[62;1H[K[62;112H105,2-9[7C27%[61;9H[?12l[?25h[?25l[1;61r[61;1H
[1;62r[61;17H[32munsigned[m [32mint[m code_frame_number = get_frame(PT_parent, i);[62;112H[K[62;112H106,3-17      28%[61;17H[?12l[?25h[?25l[1;61r[61;1H
[1;62r[61;17Hset_ss_pag(PT_child, i, code_frame_number);[62;112H[K[62;112H107,3-17      28%[61;17H[?12l[?25h[?25l[1;61r[1;1H[30M[1;62r[32;17Hi++;[33;9H}[35;9H[32mint[m j = [31m0[m;[37;9H[38;5;130mfor[m (i = NUM_PAG_KERNEL+NUM_PAG_CODE; i < (NUM_PAG_KERNEL+NUM_PAG_CODE+NUM_PAG_DATA); ++i) {[38;17H[32mint[m data_frame_number = ph_pages [j];[39;17Hset_ss_pag(PT_child, i, data_frame_number);[40;17Hset_ss_pag(PT_parent, i+NUM_PAG_DATA, data_frame_number);[41;17H++j;[42;9H}[44;9Hi = L_USER_START + (NUM_PAG_CODE*PAGE_SIZE);[45;17Hcopy_data(([32mvoid[m *)i, ([32mvoid[m *)((L_USER_START) + (NUM_PAG_CODE+NUM_PAG_DATA)*PAGE_SIZE), NUM_PAG_DATA*PAGE_SIZE);[47;9H[38;5;130mfor[m (i = NUM_PAG_KERNEL + NUM_PAG_CODE + NUM_PAG_DATA; i < NUM_PAG_KERNEL + NUM_PAG_CODE + ([31m2[m*NUM_PAG_DATA); i++) {[48;25Hdel_ss_pag(PT_parent, i);[49;17H}[51;9Hchild_union->task.PID = last_PID++;[53;9Hset_cr3(parent_union->task.dir_pages_baseAddr);[55;9H[34m//We could also take the ebp of the parent[56;9H//And just: ebp >> 4 (number of elements in the stack)[57;9H//stack [1023 - (ebp >> 4)][m[58;9Hchild_union->task.kernel_esp = &(child_union->stack [[31m1023[m-[31m18[m]);[59;9Hchild_union->stack[[31m1023[m-[31m17[m] = ([32munsigned[m [32mlong[m *)&ret_from_fork;[61;9H[34m// Init estadisticas[m[62;112H[K[62;112H137,2-9[7C47%[61;9H[?12l[?25h
[?1l>[?1049lVim: Caught deadly signal HUP
Vim: preserving files...
Vim: Finished.
[62;1H